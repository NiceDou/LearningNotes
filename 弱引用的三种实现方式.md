## 实现弱引用objc对象

### 方法一、使用NSValue提供的方法

```objc
//1. NSValue弱引用方式包装一个objc对象
NSValue *value = [NSValue valueWithNonretainedObject:@"objc对象"];

//2. 从NSValue获取弱引用的objc对象
id weakObj = [value nonretainedObjectValue];
```

### 方法二、借助Block对象，内部持有一个使用了`__weak`修饰的objc对象

- (1) 返回值类型是id，参数类型是void，的block类型定义

```c
typedef id (^WeakReferenceBlcok)(void);
```

- (2) 将外界传入的需要弱引用处理的对象，借助block，进行`__weak`处理

```c
WeakReferenceBlcok makeWeakReference(id obj) {
    
    //1. 对外界传入的对象进行弱引用
    id __weak weakObj = obj;
    
    //2. 返回一个Block，执行Block后，让外界拿到 __weak 处理后的弱引用用对象
    return ^() {
        return weakObj;
    };
}
```

- (3) 对NSMutableDictionary稍加封装，添加如上的处理代码

```objc
@interface XZHDic : NSObject {
    NSMutableDictionary *_dic;//TODO: 初始化代码那些就不写了.....
}

- (void)weak_setObject:(id)anObject forKey:(NSString *)aKey;
- (id)weak_getObjectForKey:(NSString *)key;

@end
@implementation XZHDic

- (void)weak_setObject:(id)anObject forKey:(NSString *)aKey {
    //1.
    WeakReferenceBlcok block = makeWeakReference(anObject);
    
    //2.
    [_dic setObject:block forKey:aKey];
}

- (id)weak_getObjectForKey:(NSString *)key {
    //1.
    WeakReferenceBlcok block = [_dic objectForKey:key];
    
    //2.
    return (block ? block() : nil);
}

@end
```

### NSProxy定义weak属性 + 消息转发

- (1) 抽象事物的接口

```objc
#import <Foundation/Foundation.h>

@protocol Human <NSObject>
- (void)run;
@end
```

- (2) 一个具体实现类

```objc
#import <Foundation/Foundation.h>
#import "Human.h"

@interface XiaoMing : NSObject <Human>
@end
@implementation XiaoMing
- (void)run {
    NSLog(@"XiaoMing run....");
}
@end
```

- (3) NSProxy代理上面具体实现类的一个对象，并且使用weak修饰的属性

```objc
#import <Foundation/Foundation.h>
#import "Human.h"

@interface XZHProxy : NSProxy <Human>

/**
 *  被代理的弱引用对象
 */
@property (nonatomic, weak, readonly) id<Human> target;

/**
 *  传入要被弱引用的对象
 */
- (instancetype)initWithTarget:(id<Human>)target;

@end
@implementation XZHProxy

- (instancetype)initWithTarget:(id<Human>)target {
    _target = target;
    return self;
}

- (id)forwardingTargetForSelector:(SEL)selector {
    return _target;
}

- (BOOL)respondsToSelector:(SEL)aSelector {
    return [_target respondsToSelector:aSelector];
}

@end
```

外界使用代码

```objc
//1. target
XiaoMing *xiaoming = [[XiaoMing alloc] init];

//2. Proxy
XZHProxy *proxy = [[XZHProxy alloc] initWithTarget:xiaoming];

//3. 使用Proxy
[proxy run];
```

输出

```
2016-11-16 00:07:33.180 demo[9202:125702] XiaoMing run....
```


摘录自博文:

```
http://www.jianshu.com/p/51156d4ae885
```
